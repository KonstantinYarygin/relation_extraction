---
title: "OMG exploratory analysis"
output:
  html_document: default
---
*workflow:* https://github.com/KonstantinYarygin/relation_extraction/wiki/exploratory-analysis-workflow  
*выводы:* https://github.com/KonstantinYarygin/relation_extraction/wiki/exploratory-analysis-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D1%8B

## Data processing
```{r}
library(data.table)
library(ggplot2)
library(stringr)
library(plyr)

# warning here doesn't matter
data <- fread('~/Downloads/sentences17_50_46-01_03_16.csv', sep=',')
```
Структура данных:
```{r}
nrow(data)
str(data, vec.len=1)
```
Бактерии, нутриенты и болезни записаны в питоновском формате листа. Распарсим и конвертируем:
```{r}
data.bacteria = data[,
         .(unlist(llply(str_match_all(bacteria, '\'([^\\)]+)\''), .fun=function(x) x[,2])),
           unlist(llply(str_match_all(bacteria, '(\\d+)\\)'), .fun=function(x) x[,2]))),
         by=.(text, article_title)]
setnames(data.bacteria, c("text","article_title","bacteria","bacteria_code"))

data.nutrient = data[,
         unlist(llply(str_match_all(nutrients, ',\\s\'([^\\)]+)\''), .fun=function(x) x[,2])),
         by=.(text, article_title)]
setnames(data.nutrient, c("text","article_title","nutrient"))

data.disease = data[,.(unlist(llply(str_match_all(diseases, 
                                                  '\'([^\\)]+)\','), 
                                    .fun=function(x) x[,2])),
                      unlist(llply(str_match_all(diseases, 
                                                 ',\\s\'([^\\)]+)\''), 
                                   .fun=function(x) x[,2]))),
         by=.(text, article_title)]

setnames(data.disease, c("text","article_title","disease","disease_code"))
```
Присоединим импакты
```{r}
data.impacts <- fread('data/if2015.csv', na.strings = "Not Available")
setnames(data.impacts, c('journal', 'impact'))
# оказались дупликаты
data.impacts <- unique(data.impacts)
data.impacts$journal <- tolower(data.impacts$journal)
data <- merge(data, data.impacts, by='journal', all.x = TRUE)
nrow(data)
```

## Results
Количество предложений:
```{r} 
nrow(data)
```
Количество статей, в которых мы что-то нашли:
```{r}
length(unique(data$article_title))
```

### Из каких статей больше всего предложений?
```{r}
data.articles <- data[,length(text), by=article_title]
colnames(data.articles) <- c('title', 'sentences')
# берём первые 60 символов из названия статьи
data.articles <- data.articles[,.(substr(title, 0, 60), sentences)]
colnames(data.articles) <- c('title', 'sentences')
setorder(data.articles, -sentences)
head(data.articles, 10)
```

### Какие есть длины предложений
Длина в **символах**
```{r, fig.height=7}
data[,length:=str_length(text)]
ggplot(data, aes(x=length)) + geom_histogram(binwidth=800) +
    stat_bin(aes(y = ..count.., 
                 label = ifelse(..count..!=0, ..count..,'')), 
             binwidth=800, geom='text', vjust = -1, size=3) + theme_bw()
```

### Какие бактерии встречаются чаще всего?  
``` {r}
data.bacteria.count <- data.bacteria[,.N,by=bacteria_code]
data.bacteria.unique <- data.bacteria[,.(bacteria, bacteria_code)]
setkey(data.bacteria.unique, bacteria_code)
data.bacteria.unique <- unique(data.bacteria.unique)
data.bacteria.count <- merge(data.bacteria.count, data.bacteria.unique, by='bacteria_code')
setorder(data.bacteria.count, -N)
head(data.bacteria.count, 10)
nrow(data.bacteria.count)
ggplot(data.bacteria.count[0:10], aes(x = reorder(bacteria,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('bacteria') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
ggplot(data.bacteria.count, aes(x = reorder(bacteria,-N), y = N, group=1)) + 
  geom_line(color="green", size=1) + 
  theme_bw() + 
  xlab('bacteria') + 
  ylab('count') + geom_hline(yintercept=0) +  
  theme(axis.line=element_line(colour = "grey"), axis.text.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank())
````

### Какие нутриенты встречаются чаще всего?  

```{r}
data.nutrient.count <- data.nutrient[,.N,by=nutrient]
setorder(data.nutrient.count, -N)
head(data.nutrient.count, 10)
nrow(data.nutrient.count)
ggplot(data.nutrient.count[0:10], aes(x = reorder(nutrient,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('nutrient') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
ggplot(data.nutrient.count, aes(x = reorder(nutrient,-N), y = N, group=1)) + 
  geom_line(color="green", size=1) + 
  theme_bw() + 
  xlab('nutrient') + 
  ylab('count') + geom_hline(yintercept=0) +  
  theme(axis.line=element_line(colour = "grey"), axis.text.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank())
```

### Какие болезни встречаются чаще всего?  
```{r}
data.disease.count <- data.disease[,.N,by=disease_code]
data.disease.unique <- data.disease[,.(disease, disease_code)]
setkey(data.disease.unique, disease_code)
data.disease.unique <- unique(data.disease.unique)
data.disease.count <- merge(data.disease.count, data.disease.unique, by='disease_code')
setorder(data.disease.count, -N)
head(data.disease.count, 10)
nrow(data.disease.count)
ggplot(data.disease.count[0:10], aes(x = reorder(disease,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('disease') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
ggplot(data.disease.count, aes(x = reorder(disease,-N), y = N, group=1)) + 
  geom_line(color="green", size=1) + 
  theme_bw() + 
  xlab('disease') + 
  ylab('count') + geom_hline(yintercept=0) +  
  theme(axis.line=element_line(colour = "grey"), axis.text.x=element_blank(), 
        axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank())
```

### Какие пары бактерия-нутриент встречаются чаще всего?  

Если в предложении встретилось имя бактерии несколько раз или нутриент несколько раз - считаем это за один раз. Например, если в предложении три раза встретилась бактерия Б1 и два раза встретился нутриент Н1, то считаем это за один случай Б1-Н1.
```{r}
data.bacteria.nutrient <- merge(data.bacteria, data.nutrient, by = c("text","article_title"))
data.bacteria.nutrient <- unique(data.bacteria.nutrient)
data.bacteria.nutrient.count <- data.bacteria.nutrient[,.N,by=c('bacteria_code','nutrient')]
data.bacteria.nutrient.count <- merge(data.bacteria.nutrient.count, 
                                      data.bacteria.unique, 
                                      by='bacteria_code')
setorder(data.bacteria.nutrient.count, -N)
head(data.bacteria.nutrient.count, 10)
nrow(data.bacteria.nutrient.count)
ggplot(data.bacteria.nutrient.count[0:8], aes(x = reorder(paste(bacteria,nutrient,sep = ' + '),-N), 
                                               y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('pair') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Какие пары бактерия-болезнь встречаются чаще всего?  
```{r}
data.bacteria.disease <- merge(data.bacteria, data.disease, by = c("text","article_title"))
data.bacteria.disease <- unique(data.bacteria.disease)
data.bacteria.disease.count <- data.bacteria.disease[,.N,by=c('bacteria_code','disease')]
data.bacteria.disease.count <- merge(data.bacteria.disease.count,
                                     data.bacteria.unique, 
                                     by='bacteria_code')
setorder(data.bacteria.disease.count, -N)
head(data.bacteria.disease.count, 10)
nrow(data.bacteria.disease.count)
ggplot(data.bacteria.disease.count[0:8], aes(x = reorder(paste(bacteria,disease,sep = ' + '),-N), 
                                               y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('pair') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Журналы  
#### Из каких журналов больше всего предложений?  
```{r}
data.journal.count <- data[,.N, by=journal]
setorder(data.journal.count, -N)
ggplot(data.journal.count[0:20], aes(x = reorder(journal, N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('journal') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1)) +
  coord_flip()
```

#### Какие есть импакты журналов
```{r}
ggplot() + aes(unique(data$impact)) + geom_histogram(binwidth=1) +
    stat_bin(aes(y = ..count.., 
                 label = ifelse(..count..!=0, ..count..,'')), 
             binwidth=1, geom='text', vjust = -1, size=3) +
  xlab("impact") + theme_bw()
```

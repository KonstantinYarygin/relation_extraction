---
title: "OMG exploratory analysis"
author: "Vasilyev A."
date: "February 20, 2016"
output: html_document
---
*workflow:* https://github.com/KonstantinYarygin/relation_extraction/wiki/exploratory-analysis-workflow

## Data processing
```{r}
library(data.table)
library(ggplot2)
library(stringr)
library(plyr)

# warning here doesn't matter
data <- fread('sentences.csv', sep=',')
str(data, vec.len=1)
```
Бактерии, нутриенты и болезни записаны в питоновском формате листа. Распарсим и конвертируем:
```{r}
data.bacteria = data[,
         unlist(llply(str_match_all(bacteria, 
                                    '\'([A-z \\.]+)\''), 
                      .fun=function(x) x[,2])),
         by=.(text, article_title)]
setnames(data.bacteria, c("text","article_title","bacteria"))

data.nutrient = data[,
         unlist(llply(str_match_all(nutrients, 
                                    '\'([A-z \\.]+)\''), 
                      .fun=function(x) x[,2])),
         by=.(text, article_title)]
setnames(data.nutrient, c("text","article_title","nutrient"))

data.disease = data[,
         unlist(llply(str_match_all(diseases, 
                                    '\'([A-z \\.]+)\''), 
                      .fun=function(x) x[,2])),
         by=.(text, article_title)]
setnames(data.disease, c("text","article_title","disease"))
```

У нас 9 000 статей. Кол-во статей, в которых мы что-то нашли:
```{r}
length(unique(data$article_title))
```

## Results

### Из каких статей больше всего предложений?
```{r}
data.articles <- data[,length(text), by=article_title]
colnames(data.articles) <- c('title', 'sentences')
# берём первые 60 символов из названия статьи
data.articles <- data.articles[,.(substr(title, 0, 60), sentences)]
colnames(data.articles) <- c('title', 'sentences')
setorder(data.articles, -sentences)
head(data.articles, 10)
```

### Какие бактерии встречаются чаще всего?  
``` {r}
data.bacteria.count <- data.bacteria[,.N,by=bacteria]
setorder(data.bacteria.count, -N)
head(data.bacteria.count, 10)
nrow(data.bacteria.count)
ggplot(data.bacteria.count[0:10], aes(x = reorder(bacteria,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('bacteria') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Какие нутриенты встречаются чаще всего?  

```{r}
data.nutrient.count <- data.nutrient[,.N,by=nutrient]
setorder(data.nutrient.count, -N)
head(data.nutrient.count, 10)
nrow(data.nutrient.count)
ggplot(data.nutrient.count[0:10], aes(x = reorder(nutrient,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('nutrient') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Какие болезни встречаются чаще всего?  
```{r}
data.disease.count <- data.disease[,.N,by=disease]
setorder(data.disease.count, -N)
head(data.disease.count, 10)
nrow(data.disease.count)
ggplot(data.disease.count[0:10], aes(x = reorder(disease,-N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('disease') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Какие пары бактерия-нутриент встречаются чаще всего?  

Если в предложении встретилось имя бактерии несколько раз или нутриент несколько раз - считаем это за один раз. Например, если в предложении три раза встретилась бактерия Б1 и два раза встретился нутриент Н1, то считаем это за один случай Б1-Н1.
```{r}
data.bacteria.nutrient <- merge(data.bacteria, data.nutrient, by = c("text","article_title"))
data.bacteria.nutrient <- unique(data.bacteria.nutrient)
data.bacteria.nutrient.count <- data.bacteria.nutrient[,.N,by=c('bacteria','nutrient')]
setorder(data.bacteria.nutrient.count, -N)
head(data.bacteria.nutrient.count, 10)
nrow(data.bacteria.nutrient.count)
ggplot(data.bacteria.nutrient.count[0:8], aes(x = reorder(paste(bacteria,nutrient,sep = ' + '),-N), 
                                               y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('pair') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

Без агара:

```{r}
data.bacteria.nutrient.count.no.agar = 
  data.bacteria.nutrient.count[nutrient!='agar'&nutrient!='Agar']
head(data.bacteria.nutrient.count.no.agar, 10)
nrow(data.bacteria.nutrient.count.no.agar)
ggplot(data.bacteria.nutrient.count.no.agar[0:8], 
       aes(x = reorder(paste(bacteria, nutrient, sep = ' + '),-N), 
                                               y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('pair') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

### Какие пары бактерия-болезнь встречаются чаще всего?  
```{r}
data.bacteria.disease <- merge(data.bacteria, data.disease, by = c("text","article_title"))
data.bacteria.disease <- unique(data.bacteria.disease)
data.bacteria.disease.count <- data.bacteria.disease[,.N,by=c('bacteria','disease')]
setorder(data.bacteria.disease.count, -N)
head(data.bacteria.disease.count, 10)
nrow(data.bacteria.disease.count)
ggplot(data.bacteria.disease.count[0:8], aes(x = reorder(paste(bacteria,disease,sep = ' + '),-N), 
                                               y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('pair') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1))
```

3. Журналы  
3.1. Из каких журналов больше всего **предложений**?  
3.2. Из каких журналов больше всего **фактов**? - здесь нужны 100 отобранных фактов от Кости

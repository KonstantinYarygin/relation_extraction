---
title: "OMG exploratory analysis"
output:
  html_document: default
---
*workflow:* https://github.com/KonstantinYarygin/relation_extraction/wiki/exploratory-analysis-workflow  
*выводы:* https://github.com/KonstantinYarygin/relation_extraction/wiki/exploratory-analysis-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D1%8B

```{r lib, echo=FALSE}
GetHistPlots <- function(data.count, x.variable){
  setnames(data.count, x.variable, "object")
  plot1 <- ggplot(data.count[0:10], aes(x = reorder(object, -N), y = N)) + 
    geom_bar(stat="identity") + 
    theme_bw() + 
    xlab(x.variable) + 
    ylab('count') + 
    theme(text = element_text(size=13), 
          axis.text.x = element_text(angle=10, vjust=1))
  plot2 <- ggplot(data.count, aes(x = reorder(object, -N), y = N, group=1)) + 
    geom_line(color="green", size=1) + 
    theme_bw() + 
    xlab(x.variable) + 
    ylab('count') + geom_hline(yintercept=0) +  
    theme(axis.line=element_line(colour = "grey"), axis.text.x=element_blank(), 
          axis.text.x=element_blank(), axis.ticks.x=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank())
  return(list(plot1=plot1, plot2=plot2))
}

MergePlotBactPairs <- function(data.bacteria, data.other, column.other){
  data.bacteria.other <- merge(data.bacteria, data.other, by = c("text","article_title"))
  data.bacteria.other <- unique(data.bacteria.other)
  data.bacteria.other.count <- data.bacteria.other[,.N,by=c('bacteria_code',column.other)]
  data.bacteria.other.count <- merge(data.bacteria.other.count, 
                                        data.bacteria.unique, 
                                        by='bacteria_code')
  setorder(data.bacteria.other.count, -N)
  head(data.bacteria.other.count, 10)
  nrow(data.bacteria.other.count)
  setnames(data.bacteria.other.count, column.other, "other")
  plot <- ggplot(data.bacteria.other.count[0:8], aes(x = reorder(paste(bacteria,
                                                                       other,
                                                                       sep = ' + '),-N), 
                                                     y = N)) + 
    geom_bar(stat="identity") + 
    theme_bw() + 
    xlab('pair') + 
    ylab('count') + 
    theme(text = element_text(size=13), 
          axis.text.x = element_text(angle=10, vjust=1))
  setnames(data.bacteria.other.count, "other", column.other)
  return(list(plot=plot, data.bacteria.other.count=data.bacteria.other.count))
}
```

## Data processing
```{r}
library(data.table)
library(ggplot2)
library(stringr)
library(plyr)

# warning here doesn't matter
data <- fread('~/Downloads/result_17_07_29-28_03_16.csv', sep='\t')
```
Структура данных:
```{r}
nrow(data)
str(data, vec.len=1)
```
Бактерии, нутриенты и болезни записаны в питоновском формате листа. Распарсим и конвертируем
```{r parsing, echo=FALSE, cache=T}
data.bacteria <- data[,
         .(unlist(llply(str_match_all(bacteria, '\'([^\\)]+)\''), .fun=function(x) x[,2])),
           unlist(llply(str_match_all(bacteria, '(\\d+)\\)'), .fun=function(x) x[,2]))),
         by=.(text, article_title, journal)]
setnames(data.bacteria, c("text","article_title", "journal", "bacteria","bacteria_code"))

data.nutrient <- data[,
         unlist(llply(str_match_all(nutrients, ',\\s\'([^\\)]+)\''), .fun=function(x) x[,2])),
         by=.(text, article_title, journal)]
setnames(data.nutrient, c("text","article_title", "journal", "nutrient"))

data.disease <- data[,.(unlist(llply(str_match_all(diseases, 
                                                  '\'([^\\)]+)\','), 
                                    .fun=function(x) x[,2])),
                      unlist(llply(str_match_all(diseases, 
                                                 ',\\s\'([^\\)]+)\''), 
                                   .fun=function(x) x[,2]))),
         by=.(text, article_title, journal)]
setnames(data.disease, c("text","article_title", "journal", "disease","disease_code"))

data.food <- data[,.(unlist(llply(str_match_all(food, 
                                                  '\'([^\\)]+)\','), 
                                    .fun=function(x) x[,2])),
                      unlist(llply(str_match_all(food, 
                                                 ',\\s\'([^\\)]+)\''), 
                                   .fun=function(x) x[,2]))),
         by=.(text, article_title, journal)]
setnames(data.food, c("text","article_title","journal","food","foodgroup"))
```
Почистим данные
```{r data-cleanup, echo=FALSE}
data.bacteria.catalog <- fread("../data/bacteria/gut_catalog.csv")
data.bacteria <- data.bacteria[bacteria_code %in% data.bacteria.catalog$id]
data.bacteria <- data.bacteria[bacteria_code != 562] # no E. coli
data.bacteria <- data.bacteria[bacteria_code != 1496] # no Clostridium difficile
data.bacteria <- data.bacteria[bacteria_code != 590] # no Salmonella
data.food <- data.food[food != "water"]

data.sentences <- data.table(unique(rbind(data.bacteria[,.(text, article_title, journal)], 
                                          data.nutrient[,.(text, article_title, journal)],
                                          data.disease[,.(text, article_title, journal)],
                                          data.food[,.(text, article_title, journal)])))
```

Присоединим импакты
```{r get-impacts, echo=FALSE}
data.impacts <- fread('../data/if2015.csv', na.strings = "Not Available")
setnames(data.impacts, c('journal', 'impact'))
# оказались дупликаты
data.impacts <- unique(data.impacts)
data.impacts$journal <- tolower(data.impacts$journal)
data.sentences <- merge(data.sentences, data.impacts, by='journal', all.x = TRUE)
```

## Results
Количество предложений:
```{r} 
length(unique(data.sentences$text))
```

Количество статей, в которых мы что-то нашли:
```{r}
length(unique(data.sentences$article_title))
```

### Из каких статей больше всего предложений?
```{r}
data.articles <- data.sentences[,length(text), by=article_title]
colnames(data.articles) <- c('title', 'sentences')
# берём первые 60 символов из названия статьи
data.articles <- data.articles[,.(substr(title, 0, 60), sentences)]
colnames(data.articles) <- c('title', 'sentences')
setorder(data.articles, -sentences)
head(data.articles, 10)
```

### Какие есть длины предложений

Длина в **символах**
```{r, fig.height=7}
data.sentences[,length:=str_length(text)]
ggplot(data.sentences, aes(x=length)) + geom_histogram(binwidth=400) +
    stat_bin(aes(y = ..count.., 
                 label = ifelse(..count..!=0, ..count..,'')), 
             binwidth=400, geom='text', vjust = -1, size=3) + theme_bw()
```

### Какие бактерии встречаются чаще всего?  
``` {r}
data.bacteria.count <- data.bacteria[,.N,by=bacteria_code]
data.bacteria.unique <- data.bacteria[,.(bacteria, bacteria_code)]
setkey(data.bacteria.unique, bacteria_code)
data.bacteria.unique <- unique(data.bacteria.unique)
data.bacteria.count <- merge(data.bacteria.count, data.bacteria.unique, by='bacteria_code')
setorder(data.bacteria.count, -N)
head(data.bacteria.count, 10)
nrow(data.bacteria.count)
plots <- GetHistPlots(data.bacteria.count, "bacteria")
plots[[1]]
plots[[2]]
```

### Какие нутриенты встречаются чаще всего?  

```{r}
data.nutrient.count <- data.nutrient[,.N,by=nutrient]
setorder(data.nutrient.count, -N)
head(data.nutrient.count, 10)
nrow(data.nutrient.count)
plots <- GetHistPlots(data.nutrient.count, "nutrient")
plots[[1]]
plots[[2]]
```

### Какие болезни встречаются чаще всего?  
```{r}
data.disease.count <- data.disease[,.N,by=disease_code]
data.disease.unique <- data.disease[,.(disease, disease_code)]
setkey(data.disease.unique, disease_code)
data.disease.unique <- unique(data.disease.unique)
data.disease.count <- merge(data.disease.count, data.disease.unique, by='disease_code')
setorder(data.disease.count, -N)
head(data.disease.count, 10)
nrow(data.disease.count)
plots <- GetHistPlots(data.disease.count, "disease")
plots[[1]]
plots[[2]]
```

### Какая еда встречается чаще всего?

Еда:
```{r}
data.food.count <- data.food[,.N,by=food]
setorder(data.food.count, -N)
head(data.food.count, 10)
nrow(data.food.count)
plots <- GetHistPlots(data.food.count, "food")
plots[[1]]
plots[[2]]
```

Группы:
```{r}
data.food.group.count <- data.food[,.N,by=foodgroup]
setorder(data.food.group.count, -N)
head(data.food.group.count, 10)
nrow(data.food.group.count)
plots <- GetHistPlots(data.food.group.count, "foodgroup")
plots[[1]]
plots[[2]]
```

Вся встретившаяся еда записана в файл:
```{r, echo=FALSE}
food.file <- file.path(getwd(), 'food.csv')
write.table(x = unique(data.food[,.(foodgroup, food)]), 
            food.file, 
            row.names = F, quote = F, sep='\t')
food.file
```


### Какие пары бактерия-нутриент встречаются чаще всего?  

Если в предложении встретилось имя бактерии несколько раз или нутриент несколько раз - считаем это за один раз. Например, если в предложении три раза встретилась бактерия Б1 и два раза встретился нутриент Н1, то считаем это за один случай Б1-Н1.
```{r}
bacteria.nutrient <- MergePlotBactPairs(data.bacteria, data.nutrient, "nutrient")
head(bacteria.nutrient$data.bacteria.other.count, 10)
nrow(bacteria.nutrient$data.bacteria.other.count)
bacteria.nutrient$plot
```


### Какие пары бактерия-болезнь встречаются чаще всего?  
```{r}
bacteria.disease <- MergePlotBactPairs(data.bacteria, data.disease, "disease")
head(bacteria.disease$data.bacteria.other.count, 10)
nrow(bacteria.disease$data.bacteria.other.count)
bacteria.disease$plot
```

### Какие пары бактерия-еда встречаются чаще всего?
```{r}
bacteria.food <- MergePlotBactPairs(data.bacteria, data.food, "food")
head(bacteria.food$data.bacteria.other.count, 10)
nrow(bacteria.food$data.bacteria.other.count)
bacteria.food$plot
```

### Журналы  
#### Из каких журналов больше всего предложений?  
```{r, fig.width=10}
data.journal.count <- data[,.N, by=journal]
setorder(data.journal.count, -N)
ggplot(data.journal.count[0:20], aes(x = reorder(journal, N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('journal') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1)) +
  coord_flip()
```

#### Какие есть импакты журналов
```{r}
ggplot() + aes(data$impact) + geom_histogram(binwidth=1) +
    stat_bin(aes(y = ..count.., 
                 label = ifelse(..count..!=0, ..count..,'')), 
             binwidth=1, geom='text', vjust = -1, size=3) +
  xlab("impact") + theme_bw()
```

#### Из каких журналов у нас еда
```{r journal-food, fig.width=10}
data.journal.food.count <- data.food[,.N, by=journal]
setorder(data.journal.food.count, -N)
ggplot(data.journal.food.count[0:20], aes(x = reorder(journal, N), y = N)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  xlab('journal') + 
  ylab('count') + 
  theme(text = element_text(size=13), 
        axis.text.x = element_text(angle=10, vjust=1)) +
  coord_flip()
```

